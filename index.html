<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>网红打卡相机 v9.0</title>
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            --cam-width: 320px; /* 加宽一点显示文字 */
            --cam-height: 240px;
            --paper-width: 180px;
            --paper-height: 216px;
        }
        body {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background-color: #111;
            background-image: radial-gradient(circle at center, #222 0%, #000 100%);
            overflow: hidden; font-family: -apple-system, sans-serif;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
        }
        #photo-wall { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; touch-action: none; }
        
        .camera-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); width: var(--cam-width); height: var(--cam-height); z-index: 100; }
        
        .camera-body { 
            width: 100%; height: 100%; background: #e0e0e0; border-radius: 28px; 
            box-shadow: 0 25px 60px rgba(0,0,0,0.7), inset 0 2px 5px rgba(255,255,255,0.9); 
            position: relative; display: flex; justify-content: center; align-items: center; z-index: 102; 
        }

        .stripe { 
            position: absolute; top: 20px; width: 100%; height: 8px; 
            background: linear-gradient(to right, #ff3b30, #ff9500, #ffcc00, #4cd964, #5ac8fa, #007aff); 
            z-index: 0;
        }
        
        /* 镜头区域 */
        .lens-area { 
            width: 130px; height: 130px; background: #000; border-radius: 50%; 
            border: 4px solid #ccc; box-shadow: 0 5px 25px rgba(0,0,0,0.5); overflow: hidden; 
            position: relative; z-index: 10; display: flex; justify-content: center; align-items: center;
        }
        
        .video-wrapper { width: 100%; height: 100%; position: relative; }
        video#camera-feed { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); 
            background: #000; filter: brightness(1.1) contrast(1.05); 
        }

        /* 预览叠加层 */
        #scene-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            opacity: 0.5; 
            mix-blend-mode: overlay;
            pointer-events: none;
            transform: scaleX(-1);
        }

        /* --- 底部滑杆 (浓度) --- */
        .slider-container {
            position: absolute; bottom: 15px; width: 140px; height: 20px; z-index: 25;
            display: flex; align-items: center; justify-content: center;
        }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #ff3b30; cursor: pointer; margin-top: -6px; border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #bbb; border-radius: 2px;
        }

        /* --- 左侧：网红地点选择 --- */
        .controls-left {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 8px; z-index: 20;
            max-height: 180px; overflow-y: auto; /* 如果地点太多可以滚动 */
            padding-right: 5px;
            /* 隐藏滚动条 */
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .controls-left::-webkit-scrollbar { display: none; }

        .scene-item {
            display: flex; flex-direction: column; align-items: center; gap: 2px;
            cursor: pointer; opacity: 0.7; transition: all 0.2s;
        }
        .scene-item.active { opacity: 1; transform: scale(1.1); }
        .scene-item.active .thumb { border-color: #ff3b30; box-shadow: 0 0 8px #ff3b30; }
        .scene-item.active .label { color: #ff3b30; font-weight: bold; }

        .thumb {
            width: 36px; height: 36px; border-radius: 50%;
            background-size: cover; background-position: center; background-color: #333;
            border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .label { font-size: 9px; color: #555; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }

        /* --- 右侧：快门 --- */
        .controls-right {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%); z-index: 20;
        }
        .shutter-btn { 
            width: 56px; height: 56px; background: #ff3b30; border-radius: 50%; 
            border: 4px solid #fff; touch-action: manipulation; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); 
            transition: transform 0.05s, box-shadow 0.05s; 
        }
        .shutter-btn:active { transform: scale(0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.4); }

        /* 拍立得照片样式 */
        .slot { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 200px; height: 12px; background: #111; border-radius: 6px; z-index: 101; }
        .polaroid { 
            position: absolute; width: var(--paper-width); height: var(--paper-height); background: #fff; 
            padding: 12px 12px 50px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            box-sizing: border-box; display: flex; justify-content: center; align-items: flex-start; 
            touch-action: none; will-change: transform, opacity; 
        }
        .polaroid-img { width: 100%; height: 156px; background: #222; overflow: hidden; }
        .polaroid-img img { width: 100%; height: 100%; object-fit: cover; }
        .delete-btn { position: absolute; top: -15px; right: -15px; width: 30px; height: 30px; background: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 28px; font-size: 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.4); cursor: pointer; z-index: 1001; display: none; border: 2px solid #fff; }
        @keyframes develop { 0% { filter: brightness(5) blur(10px) grayscale(100%); opacity: 0.5; } 40% { filter: brightness(1.5) blur(2px) sepia(50%); opacity: 0.9; } 100% { filter: none; opacity: 1; } }
        .developing { animation: develop 1.5s ease-out forwards; }
        .hint-text { position: absolute; width: 100%; top: 15%; text-align: center; color: rgba(255,255,255,0.4); font-size: 14px; pointer-events: none; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="photo-wall">
        <div class="hint-text" id="status-text">左侧选择地点 · 底部调节清晰度</div>
    </div>

    <div class="camera-container">
        <div class="slot"></div>
        <div id="eject-layer" style="position: absolute; top: 0; left: 30px; width: 180px; height: 10px; z-index: 90;"></div>
        
        <div class="camera-body">
            <div class="stripe"></div>
            
            <!-- 左侧：流行图片库 (用户直接选) -->
            <div class="controls-left">
                <!-- 无 -->
                <div class="scene-item active" onclick="setScene(null, this)">
                    <div class="thumb" style="background: #444; display:flex; justify-content:center; align-items:center; color:#fff; font-size:10px;">无</div>
                    <div class="label">原图</div>
                </div>

                <!-- 1. 巴黎 -->
                <div class="scene-item" onclick="setScene('https://images.unsplash.com/photo-1502602898657-3e91760cbb34?w=600&q=80', this)">
                    <div class="thumb" style="background-image: url('https://images.unsplash.com/photo-1502602898657-3e91760cbb34?w=100&q=60')"></div>
                    <div class="label">巴黎</div>
                </div>

                <!-- 2. 东京 -->
                <div class="scene-item" onclick="setScene('https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=600&q=80', this)">
                    <div class="thumb" style="background-image: url('https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=100&q=60')"></div>
                    <div class="label">东京</div>
                </div>

                <!-- 3. 纽约 -->
                <div class="scene-item" onclick="setScene('https://images.unsplash.com/photo-1496442226666-8d4a0e62e6e9?w=600&q=80', this)">
                    <div class="thumb" style="background-image: url('https://images.unsplash.com/photo-1496442226666-8d4a0e62e6e9?w=100&q=60')"></div>
                    <div class="label">纽约</div>
                </div>

                <!-- 4. 冰岛 -->
                <div class="scene-item" onclick="setScene('https://images.unsplash.com/photo-1476610182048-b716b8518aae?w=600&q=80', this)">
                    <div class="thumb" style="background-image: url('https://images.unsplash.com/photo-1476610182048-b716b8518aae?w=100&q=60')"></div>
                    <div class="label">冰岛</div>
                </div>

                <!-- 5. 赛博 -->
                <div class="scene-item" onclick="setScene('https://images.unsplash.com/photo-1515630278258-407f66498911?w=600&q=80', this)">
                    <div class="thumb" style="background-image: url('https://images.unsplash.com/photo-1515630278258-407f66498911?w=100&q=60')"></div>
                    <div class="label">霓虹</div>
                </div>
            </div>

            <!-- 中间：镜头 -->
            <div class="lens-area">
                <div class="video-wrapper">
                    <video id="camera-feed" autoplay playsinline webkit-playsinline muted></video>
                    <div id="scene-overlay"></div>
                </div>
            </div>

            <!-- 底部：浓度滑杆 -->
            <div class="slider-container">
                <input type="range" id="opacity-slider" min="0" max="100" value="60" oninput="updateOpacity(this.value)">
            </div>

            <!-- 右侧：快门 -->
            <div class="controls-right">
                <div class="shutter-btn" id="shutter"></div>
            </div>
        </div>
    </div>

    <!-- 隐藏图片加载器 -->
    <img id="active-scene-img" crossorigin="anonymous" style="display: none;">
    <canvas id="capture-canvas" style="display: none;"></canvas>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('capture-canvas');
        const shutterBtn = document.getElementById('shutter');
        const ejectLayer = document.getElementById('eject-layer');
        const photoWall = document.getElementById('photo-wall');
        const statusText = document.getElementById('status-text');
        const sceneOverlay = document.getElementById('scene-overlay');
        const activeSceneImg = document.getElementById('active-scene-img');

        let currentSceneUrl = null;
        let overlayOpacity = 0.6; 

        // --- 1. 场景切换 ---
        function setScene(url, item) {
            document.querySelectorAll('.scene-item').forEach(b => b.classList.remove('active'));
            if(item) item.classList.add('active');

            currentSceneUrl = url;
            if (url) {
                sceneOverlay.style.backgroundImage = `url(${url})`;
                activeSceneImg.src = url;
                updateOpacity(document.getElementById('opacity-slider').value);
            } else {
                sceneOverlay.style.backgroundImage = 'none';
                activeSceneImg.removeAttribute('src');
            }
        }

        // --- 2. 调节浓度 (解决虚化问题) ---
        function updateOpacity(val) {
            overlayOpacity = val / 100;
            if (currentSceneUrl) {
                sceneOverlay.style.opacity = overlayOpacity;
                // 如果浓度 > 65%，使用 Normal 模式（清晰背景）
                // 如果浓度 < 65%，使用 Overlay 模式（唯美融合）
                if (overlayOpacity > 0.65) {
                    sceneOverlay.style.mixBlendMode = 'normal';
                } else {
                    sceneOverlay.style.mixBlendMode = 'overlay';
                }
            }
        }

        // --- 3. 初始化 ---
        async function initCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 1280 } },
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play().catch(e => console.log(e));
                    statusText.innerText = "左侧选地点，底部调浓度";
                    setTimeout(() => statusText.style.opacity = '0', 4000);
                };
            } catch (err) { statusText.innerText = "请允许摄像头权限"; }
        }
        initCamera();

        // --- 4. 拍照合成 ---
        const handleShoot = (e) => {
            if(e.cancelable) e.preventDefault();
            if (!video.srcObject) return;
            try { playShutterSound(); } catch(e){}
            shutterBtn.style.transform = 'scale(0.85)';
            setTimeout(() => shutterBtn.style.transform = 'none', 80);

            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                if(canvas.width === 0) return;
                const ctx = canvas.getContext('2d');
                
                // 绘制人像
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.filter = 'brightness(110%) contrast(105%)';
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.filter = 'none';

                // 绘制风景
                if (currentSceneUrl && activeSceneImg.complete && activeSceneImg.naturalWidth > 0) {
                    ctx.globalAlpha = overlayOpacity; 
                    
                    if (overlayOpacity > 0.65) {
                        ctx.globalCompositeOperation = 'source-over'; // 清晰模式
                    } else {
                        ctx.globalCompositeOperation = 'overlay'; // 融合模式
                    }
                    
                    ctx.drawImage(activeSceneImg, 0, 0, canvas.width, canvas.height);
                    
                    ctx.globalAlpha = 1.0;
                    ctx.globalCompositeOperation = 'source-over';
                }

                createPolaroid(canvas.toDataURL('image/jpeg', 0.85));
            } catch(err) { console.error(err); }
        };

        shutterBtn.addEventListener('click', handleShoot);
        shutterBtn.addEventListener('touchstart', handleShoot);

        // --- 音效与出片 ---
        let audioCtx; try { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); } catch(e) {}
        function createNoiseBuffer() { if(!audioCtx) return null; const b=audioCtx.createBuffer(1,audioCtx.sampleRate*2,audioCtx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1; return b; }
        const noiseBuffer = createNoiseBuffer();
        function playShutterSound() { if(!audioCtx)return; try{ if(audioCtx.state==='suspended')audioCtx.resume(); const t=audioCtx.currentTime; const s=audioCtx.createBufferSource(); s.buffer=noiseBuffer; const g=audioCtx.createGain(); g.gain.setValueAtTime(0.8,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.05); s.connect(g); g.connect(audioCtx.destination); s.start(t); s.stop(t+0.05); }catch(e){} }
        function playMotorSound() { if(!audioCtx)return; try{ const t=audioCtx.currentTime; const o=audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(150,t); o.frequency.linearRampToValueAtTime(100,t+0.6); const g=audioCtx.createGain(); g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.6); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.6); }catch(e){} }

        function createPolaroid(imgUrl) {
            setTimeout(playMotorSound, 100);
            const polaroid = document.createElement('div'); polaroid.className = 'polaroid';
            const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '×';
            const removePhoto = (e) => { e.stopPropagation(); polaroid.style.transition='all 0.3s ease-out'; polaroid.style.opacity='0'; polaroid.style.transform='scale(0.5)'; setTimeout(()=>{polaroid.remove(); if(video.paused)video.play();},300); };
            deleteBtn.addEventListener('touchstart', removePhoto); deleteBtn.addEventListener('click', removePhoto);
            const imgContainer = document.createElement('div'); imgContainer.className = 'polaroid-img';
            const img = document.createElement('img'); img.src = imgUrl; img.className = 'developing';
            imgContainer.appendChild(img); polaroid.appendChild(imgContainer); polaroid.appendChild(deleteBtn); ejectLayer.appendChild(polaroid);
            polaroid.style.top='10px'; polaroid.style.left='0'; polaroid.style.transform='rotate(0deg)'; polaroid.style.transition='transform 0.6s cubic-bezier(0.1, 0.9, 0.2, 1)'; polaroid.offsetHeight;
            polaroid.style.transform=`translateY(-240px) rotate(${(Math.random()*8-4).toFixed(2)}deg)`;
            setTimeout(()=>{deleteBtn.style.display='block'; makeDraggable(polaroid);},700);
        }
        function makeDraggable(e){ const r=e.getBoundingClientRect(); ejectLayer.removeChild(e); photoWall.appendChild(e); e.style.position='absolute'; e.style.left=r.left+'px'; e.style.top=r.top+'px'; e.style.transform=`rotate(${Math.random()*6-3}deg)`; e.style.transition='transform 0.2s'; let d=false,sx,sy,il,it;
        const gc=(ev)=>ev.touches?{x:ev.touches[0].clientX,y:ev.touches[0].clientY}:{x:ev.clientX,y:ev.clientY};
        const sd=(ev)=>{if(ev.target.classList.contains('delete-btn'))return; d=true; e.style.zIndex=999; e.style.transform+=' scale(1.05)'; const c=gc(ev); sx=c.x; sy=c.y; il=parseFloat(e.style.left); it=parseFloat(e.style.top);};
        const md=(ev)=>{if(!d)return; if(ev.cancelable)ev.preventDefault(); const c=gc(ev); e.style.left=`${il+c.x-sx}px`; e.style.top=`${it+c.y-sy}px`;};
        const ed=()=>{if(d){d=false; e.style.zIndex=10; e.style.transform=e.style.transform.replace(' scale(1.05)','');}};
        e.addEventListener('mousedown',sd); window.addEventListener('mousemove',md); window.addEventListener('mouseup',ed); e.addEventListener('touchstart',sd,{passive:false}); window.addEventListener('touchmove',md,{passive:false}); window.addEventListener('touchend',ed);}
    </script>
</body>
</html>
