<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>旅行拍立得 v5.0</title>
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            --cam-width: 260px; /*稍微加宽一点放滤镜*/
            --cam-height: 240px;
            --paper-width: 180px;
            --paper-height: 216px;
        }
        body {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background-color: #1a1a1a;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow: hidden; font-family: -apple-system, sans-serif;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
        }
        #photo-wall { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; touch-action: none; }
        .camera-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: var(--cam-width); height: var(--cam-height); z-index: 100; }
        
        .camera-body { 
            width: 100%; height: 100%; background: #e0e0e0; border-radius: 24px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6), inset 0 2px 5px rgba(255,255,255,0.9); 
            position: relative; display: flex; flex-direction: column; align-items: center; z-index: 102; 
        }

        .stripe { width: 100%; height: 10px; background: linear-gradient(to right, #ff3b30, #ff9500, #ffcc00, #4cd964, #5ac8fa, #007aff); margin-top: 25px; }
        
        /* 镜头区域 */
        .lens-area { 
            width: 110px; height: 110px; background: #000; border-radius: 50%; margin-top: 10px; 
            border: 3px solid #ccc; box-shadow: 0 5px 20px rgba(0,0,0,0.5); overflow: hidden; 
            position: relative; display: flex; justify-content: center; align-items: center; 
        }
        
        /* 视频容器 */
        .video-container {
            width: 100%; height: 100%; position: relative;
        }

        video#camera-feed { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); 
            filter: brightness(1.15) contrast(0.95) saturate(1.1); background: #000; 
        }

        /* 预览叠加层 */
        #preview-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            opacity: 0.3; /* 预览时的透明度 */
            pointer-events: none;
            mix-blend-mode: screen; /* 滤镜混合模式 */
            transform: scaleX(-1); /* 保持跟镜像视频一致 */
        }

        /* 滤镜滚动条 */
        .filter-scroll {
            width: 90%;
            height: 50px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding-bottom: 5px;
            /* 隐藏滚动条 */
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .filter-scroll::-webkit-scrollbar { display: none; }

        .filter-item {
            flex: 0 0 40px;
            height: 40px;
            border-radius: 50%;
            background: #999;
            margin-right: 10px;
            border: 2px solid #fff;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, border-color 0.2s;
        }
        .filter-item.active {
            border-color: #ff3b30;
            transform: scale(1.1);
        }
        .filter-item img { width: 100%; height: 100%; object-fit: cover; }
        .filter-item span { /* 无滤镜的图标 */
            display: block; width: 100%; height: 100%; background: #ccc;
            display: flex; justify-content: center; align-items: center; font-size: 12px; color: #555;
        }

        /* 快门按钮 - 位置稍微下移 */
        .shutter-btn { 
            position: absolute; right: 15px; bottom: 15px; 
            width: 50px; height: 50px; background: #ff3b30; border-radius: 50%; border: 4px solid #d1d1d6; 
            touch-action: manipulation; box-shadow: 0 4px 0 #b0261e; transition: transform 0.05s, box-shadow 0.05s; z-index: 103; 
        }
        .shutter-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #b0261e; }
        
        .slot { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 190px; height: 14px; background: #000; border-radius: 8px; z-index: 101; }
        .polaroid { position: absolute; width: var(--paper-width); height: var(--paper-height); background: #fff; padding: 12px 12px 50px 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.25); box-sizing: border-box; display: flex; justify-content: center; align-items: flex-start; touch-action: none; will-change: transform, opacity; }
        .polaroid-img { width: 100%; height: 156px; background: #222; overflow: hidden; position: relative; }
        .polaroid-img img { width: 100%; height: 100%; object-fit: cover; }
        
        .delete-btn { position: absolute; top: -15px; right: -15px; width: 30px; height: 30px; background: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 28px; font-size: 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.4); cursor: pointer; z-index: 1001; display: none; border: 2px solid #fff; }
        
        @keyframes develop { 0% { filter: brightness(5) blur(10px) grayscale(100%); opacity: 0.5; } 40% { filter: brightness(1.5) blur(2px) sepia(50%); opacity: 0.9; } 100% { filter: none; opacity: 1; } }
        .developing { animation: develop 1.5s ease-out forwards; }
        .hint-text { position: absolute; width: 100%; top: 12%; text-align: center; color: rgba(255,255,255,0.4); font-size: 14px; pointer-events: none; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="photo-wall">
        <div class="hint-text" id="status-text">滑动下方圆圈选择风景</div>
    </div>

    <div class="camera-container">
        <div class="slot"></div>
        <div id="eject-layer" style="position: absolute; top: 0; left: 30px; width: 180px; height: 10px; z-index: 90;"></div>
        
        <div class="camera-body">
            <div class="stripe"></div>
            
            <div class="lens-area">
                <div class="video-container">
                    <video id="camera-feed" autoplay playsinline webkit-playsinline muted></video>
                    <!-- 风景叠加预览层 -->
                    <div id="preview-overlay"></div>
                </div>
            </div>

            <!-- 风景选择栏 -->
            <div class="filter-scroll" id="filter-scroll">
                <div class="filter-item active" onclick="selectFilter(this, null)">
                    <span>无</span>
                </div>
                <!-- 巴黎 -->
                <div class="filter-item" onclick="selectFilter(this, 'https://images.unsplash.com/photo-1502602898657-3e91760cbb34?w=300&q=80')">
                    <img src="https://images.unsplash.com/photo-1502602898657-3e91760cbb34?w=100&q=60" alt="Paris">
                </div>
                <!-- 日本 -->
                <div class="filter-item" onclick="selectFilter(this, 'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=300&q=80')">
                    <img src="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=100&q=60" alt="Japan">
                </div>
                <!-- 纽约 -->
                <div class="filter-item" onclick="selectFilter(this, 'https://images.unsplash.com/photo-1496442226666-8d4a0e62e6e9?w=300&q=80')">
                    <img src="https://images.unsplash.com/photo-1496442226666-8d4a0e62e6e9?w=100&q=60" alt="NYC">
                </div>
                <!-- 极光 -->
                <div class="filter-item" onclick="selectFilter(this, 'https://images.unsplash.com/photo-1531366936337-7c912a4589a7?w=300&q=80')">
                    <img src="https://images.unsplash.com/photo-1531366936337-7c912a4589a7?w=100&q=60" alt="Aurora">
                </div>
                <!-- 海滩 -->
                <div class="filter-item" onclick="selectFilter(this, 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=300&q=80')">
                    <img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=100&q=60" alt="Beach">
                </div>
            </div>

            <button class="shutter-btn" id="shutter"></button>
        </div>
    </div>

    <!-- 隐藏的图片加载器，用于合成 -->
    <img id="active-filter-img" crossorigin="anonymous" style="display: none;">
    <canvas id="capture-canvas" style="display: none;"></canvas>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('capture-canvas');
        const shutterBtn = document.getElementById('shutter');
        const ejectLayer = document.getElementById('eject-layer');
        const photoWall = document.getElementById('photo-wall');
        const statusText = document.getElementById('status-text');
        const previewOverlay = document.getElementById('preview-overlay');
        const activeFilterImg = document.getElementById('active-filter-img');
        const filterItems = document.querySelectorAll('.filter-item');

        // 当前是否选择了风景
        let currentFilterUrl = null;

        // --- 1. 风景选择逻辑 ---
        function selectFilter(el, url) {
            // UI 更新
            filterItems.forEach(item => item.classList.remove('active'));
            el.classList.add('active');

            currentFilterUrl = url;

            if (url) {
                // 设置预览
                previewOverlay.style.backgroundImage = `url(${url})`;
                // 预加载图片用于Canvas合成
                activeFilterImg.src = url;
            } else {
                // 清除
                previewOverlay.style.backgroundImage = 'none';
                activeFilterImg.removeAttribute('src');
            }
        }

        // --- 2. 音效 ---
        let audioCtx;
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        } catch(e) {}

        function createNoiseBuffer() {
            if(!audioCtx) return null;
            const bufferSize = audioCtx.sampleRate * 2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            return buffer;
        }
        const noiseBuffer = createNoiseBuffer();

        function playShutterSound() {
            if(!audioCtx) return;
            try {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const t = audioCtx.currentTime;
                const noise1 = audioCtx.createBufferSource();
                noise1.buffer = noiseBuffer;
                const gain1 = audioCtx.createGain();
                gain1.gain.setValueAtTime(0.8, t);
                gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
                noise1.connect(gain1);
                gain1.connect(audioCtx.destination);
                noise1.start(t);
                noise1.stop(t + 0.05);
            } catch(e) {}
        }
        
        function playMotorSound() {
            if(!audioCtx) return;
            try {
                const t = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.linearRampToValueAtTime(100, t + 0.6);
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.6);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t);
                osc.stop(t + 0.6);
            } catch(e) {}
        }

        // --- 3. 初始化 ---
        async function initCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 1280 } },
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play().catch(e => console.log(e));
                    statusText.innerText = "滑动选择风景，点击红色按钮拍摄";
                    setTimeout(() => statusText.style.opacity = '0.5', 3000);
                };
            } catch (err) {
                statusText.innerText = "请允许摄像头权限";
            }
        }
        initCamera();

        // --- 4. 拍照与合成 ---
        const handleShoot = (e) => {
            if(e.cancelable) e.preventDefault();
            if (!video.srcObject) return;

            try { playShutterSound(); } catch(e){}
            
            shutterBtn.style.transform = 'scale(0.85)';
            setTimeout(() => shutterBtn.style.transform = 'none', 80);

            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                if(canvas.width === 0) return;

                const ctx = canvas.getContext('2d');
                
                // 1. 绘制摄像头 (镜像)
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                
                // 应用美颜
                ctx.filter = 'brightness(115%) contrast(95%) saturate(110%)';
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.filter = 'none';

                // 2. 绘制风景叠加 (如果选择了)
                if (currentFilterUrl && activeFilterImg.complete) {
                    ctx.globalAlpha = 0.35; // 透明度 (0.35 比较梦幻)
                    ctx.globalCompositeOperation = 'screen'; // 混合模式：滤色 (让画面变亮，适合重曝)
                    // 绘制图片铺满
                    ctx.drawImage(activeFilterImg, 0, 0, canvas.width, canvas.height);
                    
                    // 重置画笔状态
                    ctx.globalAlpha = 1.0;
                    ctx.globalCompositeOperation = 'source-over';
                }

                createPolaroid(canvas.toDataURL('image/jpeg', 0.85));
            } catch(err) {
                console.error(err);
                alert("合成失败，可能是网络图片跨域问题");
            }
        };

        shutterBtn.addEventListener('click', handleShoot);
        shutterBtn.addEventListener('touchstart', handleShoot);

        // --- 5. 生成照片 ---
        function createPolaroid(imgUrl) {
            setTimeout(playMotorSound, 100);

            const polaroid = document.createElement('div');
            polaroid.className = 'polaroid';
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '×';
            
            const removePhoto = (e) => {
                e.stopPropagation();
                polaroid.style.transition = 'all 0.3s ease-out';
                polaroid.style.opacity = '0';
                polaroid.style.transform = 'scale(0.5)';
                setTimeout(() => {
                    polaroid.remove();
                    if (video.paused) video.play(); 
                }, 300);
            };
            
            deleteBtn.addEventListener('touchstart', removePhoto);
            deleteBtn.addEventListener('click', removePhoto);

            const imgContainer = document.createElement('div');
            imgContainer.className = 'polaroid-img';
            const img = document.createElement('img');
            img.src = imgUrl;
            img.className = 'developing';
            
            imgContainer.appendChild(img);
            polaroid.appendChild(imgContainer);
            polaroid.appendChild(deleteBtn);
            ejectLayer.appendChild(polaroid);
            
            polaroid.style.top = '10px';
            polaroid.style.left = '0';
            polaroid.style.transform = `rotate(0deg)`;
            polaroid.style.transition = 'transform 0.6s cubic-bezier(0.1, 0.9, 0.2, 1)'; 
            
            polaroid.offsetHeight; 

            const randomAngle = (Math.random() * 8 - 4).toFixed(2);
            polaroid.style.transform = `translateY(-240px) rotate(${randomAngle}deg)`;

            setTimeout(() => {
                deleteBtn.style.display = 'block';
                makeDraggable(polaroid);
            }, 700);
        }

        function makeDraggable(elem) {
            const rect = elem.getBoundingClientRect();
            ejectLayer.removeChild(elem);
            photoWall.appendChild(elem);

            elem.style.position = 'absolute';
            elem.style.left = rect.left + 'px';
            elem.style.top = rect.top + 'px';
            elem.style.transform = `rotate(${Math.random()*6-3}deg)`; 
            elem.style.transition = 'transform 0.2s';

            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            const getCoords = (e) => e.touches ? {x:e.touches[0].clientX, y:e.touches[0].clientY} : {x:e.clientX, y:e.clientY};

            const startDrag = (e) => {
                if (e.target.classList.contains('delete-btn')) return;
                isDragging = true;
                elem.style.zIndex = 999;
                elem.style.transform = elem.style.transform + ' scale(1.05)';
                const coords = getCoords(e);
                startX = coords.x;
                startY = coords.y;
                initialLeft = parseFloat(elem.style.left);
                initialTop = parseFloat(elem.style.top);
            };

            const moveDrag = (e) => {
                if (!isDragging) return;
                if(e.cancelable) e.preventDefault();
                const coords = getCoords(e);
                elem.style.left = `${initialLeft + coords.x - startX}px`;
                elem.style.top = `${initialTop + coords.y - startY}px`;
            };

            const endDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    elem.style.zIndex = 10;
                    elem.style.transform = elem.style.transform.replace(' scale(1.05)', '');
                }
            };
            elem.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', moveDrag);
            window.addEventListener('mouseup', endDrag);
            elem.addEventListener('touchstart', startDrag, {passive:false});
            window.addEventListener('touchmove', moveDrag, {passive:false});
            window.addEventListener('touchend', endDrag);
        }
    </script>
</body>
</html>
